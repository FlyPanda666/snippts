# 并发编程

## 为什么要引入并发编程

引入并发,就是为了提升程序运行速度.

## 有哪些程序提升的方法

- 单线程串行

正常情况下程序的执行. 主要的问题是在IO期间,CPU处于等待的状态.

- 多线程并发

如果遇到IO操作,CPU会切换到其他的task执行操作.当IO完成以后,会通知CPU进行下一步的处理.

> CPU和IO是可以同时并行进行的.IO的执行是不需要CPU参与的.这种情况使用的是一个CPU.在Python中可以借助threading来实现.

- 多CPU并行

多个CPU多条线程来执行,实现真正的并行.

> 在Python中可以借助multiprocessing来实现.

- 多机器并行

多个机器,每个机器多个CPU.

> 可以借助hive,hadoop以及spark来实现.

## Python对并发编程的支持

- 多线程: threading,利用CPU和IO可以同时执行的原理,让CPU不会干巴巴等待IO完成.

- 多进程: multiprocessing,利用多核CPU的能力,**真正的并行执行任务**.

- 异步IO: asyncio,在单线程中利用CPU和IO同时执行的原理,实现**函数**异步执行.

使用Lock对资源加锁,防止冲突访问.
使用Queue实现不同线程\进程之间的数据通信,实现生产者、消费者模式.
使用线程池Pool\进程池Pool,简化线程\进程的任务提交、等待结果、获取结果.
使用subprocess启动外部程序的进程,并进行输入输出交互.

## 如何选择

Python并发编程有三种方式:多线程thread、多进程process、多协程coroutine.那么该如何选择呢.

- CPU密集型计算

CPU-bound(受限制),是指IO在很短的时间就可以完成,CPU需要大量的计算和处理,特点是CPU占用率相当高.
> 例如:压缩和解压缩、加密和解密、正则表达式搜索.

- IO密集型计算

IO-bound(受限制),是指系统运行大部分的状况是CPU在等待IO操作,CPU占用率仍然较低.
> 例如:文件处理程序、网络爬虫程序、读写数据库程序.

- 多线程、多进程和多协程

一个进程中可以启动N个线程,一个线程中可以启动N个协程.
由于GIL的存在,即使电脑有多核CPU,单个时刻也只能使用1个.

||多进程Process(multiprocessing)|多线程Thread(threading)|多协程Coroutine(asyncio)|
|---|---|---|---|
|优点|可以利用多核CPU并行运算|相比进程,更轻量级,占用资源少|内存开销最少,启动协程数量最多|
|缺点|占用资源最多,可启动数目比线程少|相比进程,多线程只能并发执行,不能利用多核CPU;相比协程,启动数目有限制,占用内存资源,有线程切换开销|内存开销最少,启动协程数量最多|
|适用场景|CPU密集型计算|IO密集型计算,同时运行的任务数目要求不多|IO密集型计算,需要超多任务执行,但有现成库支持|
